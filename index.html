<!DOCTYPE html>
<html lang="en">
<head>  <link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icon-192.png">
<meta name="theme-color" content="#2563eb">

<script>
  // Register Service Worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("./sw.js")
        .then(() => console.log("Service Worker registered!"));
    });
  }
</script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPD Treatment Timer</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Safe area for mobile status bars / notches */
    :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
    body { padding-top: var(--safe-top); padding-bottom: var(--safe-bottom); }
    /* Hide number input spinners on mobile */
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="root"></div>

  <!-- React + ReactDOM (UMD) + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (Compat) via CDN: App + Auth + Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Optional: Heroicons CDN (SVG paths inline via JSX) - no extra requests needed -->

  <!-- ======= Firebase Config (EDIT THESE VALUES) ======= -->
  <script>
    // 1) Create a Firebase project at https://console.firebase.google.com
    // 2) Enable Authentication -> Sign-in method -> Anonymous
    // 3) Enable Cloud Firestore in Test or Production mode
    // 4) Replace the values below with your web app's config.
    //    If you leave placeholders, the app will run in local-only demo mode (no network),
    //    but will still function and NOT throw errors.
    window.__FIREBASE_CONFIG__ = {
  apiKey: "AIzaSyCYxTOgU9J-945FtR5mLt1BX0HchCxHj6g",
  authDomain: "kpd-care.firebaseapp.com",
  projectId: "kpd-care",
  storageBucket: "kpd-care.firebasestorage.app",
  messagingSenderId: "833639795609",
  appId: "1:833639795609:web:6f7a8251319515f4a4a108",
  measurementId: "G-448HC523ZH"
};
  </script>

  <!-- ======= App Code (JSX via Babel) ======= -->
  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /*************************
     * Utility Helpers
     *************************/
    const APP_VERSION = '1.0.0';
    const DEFAULT_PHASES = ["Warming", "Filling", "Dwell", "Draining"]; 

    function classNames(...xs){ return xs.filter(Boolean).join(' '); }

    function fmtDuration(seconds){
      const s = Math.max(0, Math.floor(seconds));
      const hh = Math.floor(s / 3600).toString().padStart(2,'0');
      const mm = Math.floor((s % 3600) / 60).toString().padStart(2,'0');
      const ss = (s % 60).toString().padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }

    function nowTs(){ return new Date(); }

    function tsString(d){
      try {
        return new Intl.DateTimeFormat(undefined, {
          year: 'numeric', month: 'short', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit'
        }).format(d);
      } catch {
        return d.toISOString();
      }
    }

    // Persistent random appId stored locally so logs group under a consistent doc path
    function ensureAppId(){
      let id = localStorage.getItem('kpd.appId');
      if(!id){ id = crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(36).slice(2));
        localStorage.setItem('kpd.appId', id);
      }
      return id;
    }

    // Simple toast system
    function useToasts(){
      const [toasts, setToasts] = useState([]);
      const push = (text, ms=3000) => {
        const id = Math.random().toString(36).slice(2);
        setToasts(t => [...t, { id, text }]);
        if(ms){ setTimeout(() => setToasts(t => t.filter(x => x.id !== id)), ms); }
      };
      return { toasts, push };
    }

    /*************************
     * Firebase / Mock Layer
     *************************/
    function isConfigReady(cfg){
      if(!cfg) return false;
      const vals = Object.values(cfg||{}).join(',');
      return !(vals.includes('YOUR_API_KEY') || vals.includes('YOUR_PROJECT') || vals.includes('YOUR_APP_ID'));
    }

    function useFirebase(){
      const [state, setState] = useState({ mode: 'loading', user: null, db: null, error: null });
      useEffect(() => {
        (async () => {
          try {
            const cfg = window.__FIREBASE_CONFIG__;
            if(!isConfigReady(cfg)){
              // Demo/local mode using localStorage to "mock" Firestore
              setState({ mode: 'demo', user: { uid: 'demo-user' }, db: null, error: null });
              return;
            }
            const app = firebase.initializeApp(cfg);
            const auth = firebase.auth();
            await auth.signInAnonymously();
            const user = auth.currentUser;
            const db = firebase.firestore();
            setState({ mode: 'live', user, db, error: null });
          } catch (e){
            console.error(e);
            setState({ mode: 'error', user: null, db: null, error: e });
          }
        })();
      }, []);
      return state;
    }

    // Local demo storage helpers (for when Firebase config is not set)
    function demoSave(appId, userId, entry){
      const key = `kpd.sessions.${appId}.${userId}`;
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.push(entry);
      localStorage.setItem(key, JSON.stringify(arr));
      // Trigger storage event to simulate realtime across tabs
      try { localStorage.setItem(`${key}.ping`, String(Date.now())); } catch {}
    }
    function demoSubscribe(appId, userId, cb){
      const key = `kpd.sessions.${appId}.${userId}`;
      const emit = () => {
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        // Mimic Firestore ordering by createdAt desc
        arr.sort((a,b) => (b.createdAt?.toMillis || b.createdAt) - (a.createdAt?.toMillis || a.createdAt));
        cb(arr);
      };
      emit();
      const handler = (e) => {
        if(e.key && (e.key === key || e.key === `${key}.ping`)) emit();
      };
      window.addEventListener('storage', handler);
      return () => window.removeEventListener('storage', handler);
    }

    /*************************
     * Main App
     *************************/
    function App(){
      const appId = useMemo(() => ensureAppId(), []);
      const { toasts, push } = useToasts();
      const fb = useFirebase();

      // Phase durations (seconds) with user controls
      const [durations, setDurations] = useState(() => ({
        Warming: 60,     // defaults; user can change
        Filling: 90,
        Dwell: 300,
        Draining: 120
      }));

      // Treatment reminder (daily time HH:MM)
      const [dailyTime, setDailyTime] = useState(localStorage.getItem('kpd.dailyTime') || '');
      const reminderTimerRef = useRef(null);

      // Timer state
      const [phaseIndex, setPhaseIndex] = useState(0); // 0..3
      const [isRunning, setIsRunning] = useState(false);
      const [phaseStart, setPhaseStart] = useState(null); // Date
      const [elapsed, setElapsed] = useState(0);
      const tickRef = useRef(null);

      const userId = fb.user?.uid || '—';
      const currentPhase = DEFAULT_PHASES[phaseIndex];

      // Live tick for timer
      useEffect(() => {
        if(!isRunning){ if(tickRef.current){ clearInterval(tickRef.current); tickRef.current=null; } return; }
        tickRef.current = setInterval(() => {
          setElapsed(prev => {
            const next = prev + 1; // 1s tick
            // Auto-advance when duration reached
            if(next >= (durations[currentPhase] || Infinity)){
              setTimeout(() => advancePhase('auto'), 0);
              return prev; // freeze until advance handles it
            }
            return next;
          });
        }, 1000);
        return () => { if(tickRef.current){ clearInterval(tickRef.current); tickRef.current = null; } };
        // eslint-disable-next-line react-hooks/exhaustive-deps
      }, [isRunning, currentPhase, durations[currentPhase]]);

      function startOrReset(){
        if(isRunning){ // reset
          setIsRunning(false);
          setPhaseIndex(0);
          setElapsed(0);
          setPhaseStart(null);
          push('Session reset.');
          return;
        }
        setIsRunning(true);
        setPhaseStart(nowTs());
        setElapsed(0);
        push('Session started.');
      }

      function advancePhase(reason='manual'){
        const end = nowTs();
        const start = phaseStart || end;
        const durationSec = Math.max(0, Math.floor((end - start)/1000));

        // Build log entry
        const entry = {
          appId,
          userId: userId || 'unknown',
          phase: currentPhase,
          durationSeconds: durationSec,
          startedAt: start.toISOString(),
          endedAt: end.toISOString(),
          createdAt: (fb.mode === 'live') ? firebase.firestore.Timestamp.fromDate(end) : end.getTime(),
          deviceTime: end.toISOString(),
          appVersion: APP_VERSION,
          reason
        };

        // Persist
        if(fb.mode === 'live' && fb.db && fb.user){
          const path = fb.db
            .collection('artifacts').doc(appId)
            .collection('users').doc(fb.user.uid)
            .collection('sessions');
          path.add(entry).catch(err => console.error(err));
        } else {
          demoSave(appId, userId || 'demo-user', entry);
        }

        // Move to next
        const nextIndex = (phaseIndex + 1) % DEFAULT_PHASES.length;
        if(nextIndex === 0){ // Completed cycle
          setIsRunning(false);
          push('Cycle completed!');
        } else {
          // continue running
          setIsRunning(true);
        }
        setPhaseIndex(nextIndex);
        setPhaseStart(nowTs());
        setElapsed(0);
      }

      // Real-time session log
      const [sessions, setSessions] = useState([]);
      useEffect(() => {
        if(fb.mode === 'live' && fb.db && fb.user){
          const ref = fb.db
            .collection('artifacts').doc(appId)
            .collection('users').doc(fb.user.uid)
            .collection('sessions')
            .orderBy('createdAt', 'desc')
            .limit(200);
          const unsub = ref.onSnapshot(snap => {
            const rows = [];
            snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
            setSessions(rows);
          }, err => console.error(err));
          return () => unsub && unsub();
        } else if(fb.mode === 'demo'){
          return demoSubscribe(appId, userId || 'demo-user', setSessions);
        }
      }, [fb.mode, fb.db, fb.user, appId, userId]);

      // Daily reminder scheduling (simulated)
      useEffect(() => {
        if(reminderTimerRef.current){ clearTimeout(reminderTimerRef.current); reminderTimerRef.current = null; }
        if(!dailyTime) return;
        // schedule next occurrence today or tomorrow
        const [hh, mm] = dailyTime.split(':').map(n => parseInt(n,10));
        if(Number.isNaN(hh) || Number.isNaN(mm)) return;
        const now = new Date();
        const next = new Date();
        next.setHours(hh, mm, 0, 0);
        if(next <= now){ next.setDate(next.getDate() + 1); }
        const delay = Math.max(0, next - now);
        reminderTimerRef.current = setTimeout(function trigger(){
          showReminder("It's time to start your treatment.");
          // reschedule for next day
          const again = 24 * 60 * 60 * 1000;
          reminderTimerRef.current = setTimeout(trigger, again);
        }, delay);
        return () => { if(reminderTimerRef.current){ clearTimeout(reminderTimerRef.current); } };
      }, [dailyTime]);

      function requestNotifPerm(){
        if('Notification' in window){
          Notification.requestPermission().then(res => {
            if(res === 'granted') push('Notifications enabled.');
            else push('Notifications permission denied or dismissed.');
          });
        } else { push('Notifications not supported on this device.'); }
      }

      function showReminder(text){
        push(text, 4000);
        try { if(navigator.vibrate) navigator.vibrate([200, 100, 200]); } catch {}
        if('Notification' in window && Notification.permission === 'granted'){
          new Notification('KPD Reminder', { body: text });
        }
      }

      function handleSendSMS(){
        showReminder('Reminder sent!'); // simulation only
      }

      function handleDurationChange(phase, val){
        const n = Math.max(0, Number(val) || 0);
        setDurations(d => ({ ...d, [phase]: n }));
      }

      return (
        <div className="min-h-screen flex flex-col items-center">
          {/* Header */}
          <header className="w-full bg-white/80 backdrop-blur sticky top-0 z-20 shadow-sm">
            <div className="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
              <h1 className="text-xl font-semibold tracking-tight">KPD Treatment Timer</h1>
              <div className="text-xs text-slate-500">App v{APP_VERSION}</div>
            </div>
          </header>

          <main className="w-full max-w-3xl mx-auto px-4 py-6 grid gap-6">
            {/* IDs for remote monitoring */}
            <section className="bg-white rounded-2xl shadow p-4">
              <div className="flex flex-wrap items-center justify-between gap-2">
                <div>
                  <div className="text-sm text-slate-500">App ID</div>
                  <div className="font-mono text-sm break-all">{appId}</div>
                </div>
                <div>
                  <div className="text-sm text-slate-500">User ID</div>
                  <div className="font-mono text-sm break-all">{userId}</div>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={requestNotifPerm} className="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">Enable Notifications</button>
                  <button onClick={handleSendSMS} className="px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-500">Send SMS Reminder</button>
                </div>
              </div>
              <p className="mt-2 text-xs text-slate-500">“Send SMS Reminder” is simulated (no real SMS is sent). A toast/system notification appears instead.</p>
            </section>

            {/* Timer + Controls */}
            <section className="bg-white rounded-2xl shadow p-5">
              <div className="flex items-center justify-between">
                <h2 className="text-lg font-semibold">KPD Cycle</h2>
                <span className={classNames("text-xs px-2 py-1 rounded-full", isRunning ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600')}>{isRunning ? 'Running' : 'Idle'}</span>
              </div>

              <div className="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2">
                {DEFAULT_PHASES.map((p, i) => (
                  <div key={p} className={classNames("rounded-xl border p-3 text-center", i===phaseIndex ? 'border-slate-900 bg-slate-50' : 'border-slate-200')}>
                    <div className="text-sm font-medium">{p}</div>
                    <div className="text-xs text-slate-500">Target: {fmtDuration(durations[p]||0)}</div>
                  </div>
                ))}
              </div>

              <div className="mt-6 flex flex-col items-center">
                <div className="text-5xl font-bold tracking-tight tabular-nums">{fmtDuration(elapsed)}</div>
                <div className="text-sm text-slate-500 mt-1">Phase: <span className="font-medium">{currentPhase}</span></div>

                <div className="mt-6 flex flex-wrap items-center justify-center gap-3">
                  <button onClick={startOrReset} className={classNames("px-5 py-3 rounded-2xl text-white text-sm font-medium shadow", isRunning ? 'bg-rose-600 hover:bg-rose-500' : 'bg-emerald-600 hover:bg-emerald-500')}>
                    {isRunning ? 'Reset' : 'Start'}
                  </button>
                  <button onClick={() => advancePhase('manual')} className="px-5 py-3 rounded-2xl bg-slate-900 text-white text-sm font-medium shadow hover:bg-slate-800">
                    Next Phase
                  </button>
                </div>
              </div>

              {/* Phase duration inputs */}
              <div className="mt-8">
                <h3 className="text-sm font-semibold">Phase Durations (seconds)</h3>
                <div className="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-3">
                  {DEFAULT_PHASES.map(p => (
                    <label key={p} className="flex flex-col gap-1 text-sm">
                      <span className="text-slate-600">{p}</span>
                      <input type="number" min="0" inputMode="numeric" className="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300" value={durations[p]||0} onChange={e => handleDurationChange(p, e.target.value)} />
                    </label>
                  ))}
                </div>
              </div>
            </section>

            {/* Daily Treatment Reminder */}
            <section className="bg-white rounded-2xl shadow p-5">
              <h2 className="text-lg font-semibold">Daily Treatment Reminder</h2>
              <p className="text-sm text-slate-600 mt-1">Schedule a daily in-app notification at your preferred time. Uses browser notifications (if permitted) and an on-screen toast.</p>
              <div className="mt-4 flex flex-wrap items-center gap-3">
                <input type="time" value={dailyTime} onChange={(e)=>{ setDailyTime(e.target.value); localStorage.setItem('kpd.dailyTime', e.target.value || ''); }} className="rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300" />
                <button onClick={()=> push(dailyTime ? `Daily reminder set for ${dailyTime}.` : 'Daily reminder cleared.')} className="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-500">Save</button>
                <button onClick={()=> showReminder('Test reminder: this is what you will see.')} className="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">Send Test</button>
              </div>
            </section>

            {/* Session Log */}
            <section className="bg-white rounded-2xl shadow p-5">
              <div className="flex items-center justify-between">
                <h2 className="text-lg font-semibold">Session Log</h2>
                <span className={classNames('text-xs px-2 py-1 rounded-full', fb.mode==='live' ? 'bg-green-100 text-green-700' : fb.mode==='demo' ? 'bg-amber-100 text-amber-700' : 'bg-rose-100 text-rose-700')}>
                  {fb.mode==='live' ? 'Live: Firestore' : fb.mode==='demo' ? 'Demo: Local Only' : fb.mode}
                </span>
              </div>
              <div className="mt-3 max-h-80 overflow-auto rounded-xl border border-slate-200">
                <table className="w-full text-sm">
                  <thead className="bg-slate-50 sticky top-0">
                    <tr className="text-left text-slate-600">
                      <th className="px-3 py-2">Phase</th>
                      <th className="px-3 py-2">Duration</th>
                      <th className="px-3 py-2">Timestamp</th>
                    </tr>
                  </thead>
                  <tbody>
                    {sessions.length === 0 ? (
                      <tr><td colSpan="3" className="px-3 py-6 text-center text-slate-500">No sessions yet. Finish a phase to log data.</td></tr>
                    ) : (
                      sessions.map((s, idx) => (
                        <tr key={s.id || idx} className={idx % 2 ? 'bg-white' : 'bg-slate-50/50'}>
                          <td className="px-3 py-2 font-medium">{s.phase}</td>
                          <td className="px-3 py-2 tabular-nums">{fmtDuration(s.durationSeconds || 0)}</td>
                          <td className="px-3 py-2 text-slate-600">{(() => {
                            const d = s.createdAt && s.createdAt.toDate ? s.createdAt.toDate() : new Date(s.createdAt || s.endedAt || Date.now());
                            return tsString(d);
                          })()}</td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </section>
          </main>

          {/* Toasts */}
          <div className="fixed left-0 right-0 bottom-4 flex flex-col items-center gap-2 z-50">
            {toasts.map(t => (
              <div key={t.id} className="max-w-[90%] sm:max-w-md w-fit bg-slate-900 text-white px-4 py-2 rounded-2xl shadow">
                {t.text}
              </div>
            ))}
          </div>

          <footer className="mt-auto w-full py-8 text-center text-xs text-slate-500">
            Built with React + Tailwind + Firebase via CDNs. No build steps required.
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
